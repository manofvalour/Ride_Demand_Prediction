<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>NYC Demand Intelligence - Interactive Map</title>

    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #4338ca;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --subtext: #64748b;
            --card-hover: #f1f5f9;
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #f8fafc;
            --subtext: #94a3b8;
            --card-hover: #334155;
        }

        body, html { height: 100%; margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; }
        .app-layout { display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        .header-banner {
            background: var(--surface);
            padding: 0.75rem 1.5rem;
            display: flex;
            gap: 1.5rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
            z-index: 1001;
        }
        .clock-section { display: flex; flex-direction: column; min-width: 160px; }
        #liveClock { font-weight: 900; font-size: 1.1rem; color: var(--text); line-height: 1; }
        #liveDate { font-size: 0.65rem; font-weight: 700; color: var(--subtext); text-transform: uppercase; margin-top: 4px; }

        .citywide-counter {
            padding-left: 15px; border-left: 2px solid var(--border);
            display: flex; flex-direction: column;
        }
        .citywide-label { font-size: 0.6rem; color: var(--subtext); text-transform: uppercase; font-weight: 800; white-space: nowrap; }
        .citywide-value { color: var(--primary); font-size: 1rem; font-weight: 900; line-height: 1.2; }

        /* MAIN UI */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 380px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 1000; }
        
        .controls-container { padding: 1rem; border-bottom: 1px solid var(--border); background: var(--bg); display: flex; flex-direction: column; gap: 10px; }
        .dropdown-label { font-size: 0.65rem; font-weight: 800; color: var(--subtext); text-transform: uppercase; display: block; }
        
        .search-input-wrapper { position: relative; }
        .search-input-wrapper input {
            width: 100%; padding: 10px 10px 10px 35px; border-radius: 8px; border: 1px solid var(--border);
            font-size: 0.85rem; outline: none; box-sizing: border-box; background: var(--surface); color: var(--text);
        }
        .search-input-wrapper i { position: absolute; left: 10px; top: 10px; color: var(--subtext); }

        select {
            width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);
            font-weight: 600; color: var(--text); outline: none; background: var(--surface); cursor: pointer;
        }

        .scroll-area { flex: 1; overflow-y: auto; padding: 1rem; background: var(--surface); }
        #map { flex: 1; background: #cbd5e1; }

        /* CARDS */
        .detail-card {
            border: 1px solid var(--border);
            border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem;
            cursor: pointer; background: var(--surface); transition: all 0.2s;
        }
        .detail-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); background: var(--card-hover); }
        .detail-card.active { border: 2px solid var(--primary); background: var(--card-hover); }
        
        .congestion-indicator {
            font-size: 0.6rem; font-weight: 900; padding: 2px 6px; border-radius: 4px;
            text-transform: uppercase; display: inline-block; margin-top: 4px;
        }
        .status-high { background: #fee2e2; color: #991b1b; }
        .status-medium { background: #fef3c7; color: #92400e; }
        .status-low { background: #dcfce7; color: #166534; }

        .demand-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-top: 10px; }
        .stat-box { padding: 6px; border-radius: 6px; text-align: center; font-size: 0.65rem; font-weight: 800; }

        .hover-tooltip { padding: 8px; font-family: 'Inter', sans-serif; line-height: 1.4; }
        .tooltip-title { font-weight: 800; font-size: 14px; display: block; margin-bottom: 4px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
        .tooltip-stat { font-size: 11px; font-weight: 600; color: var(--subtext); }
        .tooltip-value { font-weight: 800; color: var(--primary); }

        .theme-toggle {
            background: var(--border); border: none; padding: 8px; border-radius: 50%;
            cursor: pointer; color: var(--text); display: flex; align-items: center; justify-content: center;
        }
        .clear-btn {
            font-size: 0.6rem; font-weight: 800; color: var(--primary); cursor: pointer;
            text-decoration: underline; float: right;
        }
    </style>
</head>
<body>

<div class="app-layout">
    <header class="header-banner">
        <div class="clock-section">
            <div id="liveClock">--:--:-- --</div>
            <div id="liveDate">---, --- --, ----</div>
        </div>

        <div class="citywide-counter">
            <span class="citywide-label">Avg Speed</span>
            <span id="cityAvgSpeed" class="citywide-value">-- MPH</span>
        </div>

        <div class="citywide-counter">
            <span class="citywide-label">Congestion Index</span>
            <span id="cityCongestion" class="citywide-value">--</span>
        </div>

        <div class="citywide-counter">
            <span class="citywide-label">Congestion Level</span>
            <span id="cityCongestionLevel" class="citywide-value">--</span>
        </div>

        <div class="citywide-counter">
            <span class="citywide-label">Feels Like</span>
            <span id="cityFeelsLike" class="citywide-value">--</span>
        </div>

        <div class="citywide-counter">
            <span class="citywide-label">Humidity</span>
            <span id="cityHumidity" class="citywide-value">--</span>
        </div>

        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
            <i data-lucide="moon" id="themeIcon" size="18"></i>
        </button>

        <div style="margin-left: auto; font-size: 0.6rem; font-weight: 900; background: #fee2e2; color: #b91c1c; padding: 6px 12px; border-radius: 6px; border: 1px solid #fecaca;">
            <i data-lucide="map-pin" size="12" style="display:inline; margin-right:4px;"></i>NY TIME: LIVE FEED
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <div class="controls-container">
                <div>
                    <span class="dropdown-label">Search Neighborhood</span>
                    <div class="search-input-wrapper">
                        <i data-lucide="search" size="16"></i>
                        <input type="text" id="zoneSearch" placeholder="Type to filter...">
                    </div>
                </div>
                <div>
                    <span class="dropdown-label">Filter Borough</span>
                    <select id="boroughFilter">
                        <option value="All">All Boroughs</option>
                        <option value="Manhattan">Manhattan</option>
                        <option value="Brooklyn">Brooklyn</option>
                        <option value="Queens">Queens</option>
                        <option value="Bronx">Bronx</option>
                        <option value="Staten Island">Staten Island</option>
                    </select>
                </div>
            </div>
            <div style="padding: 1rem 1rem 0.5rem 1rem; background: var(--bg); border-bottom: 1px solid var(--border);">
                <div id="listTitleContainer">
                    <span id="listTitle" style="font-weight: 800; color: var(--primary); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em;">Zone Analytics</span>
                    <span id="clearSelection" class="clear-btn" style="display:none;" onclick="resetSelection()">Reset View</span>
                </div>
            </div>
            <div class="scroll-area" id="zoneList"></div>
        </aside>
        <div id="map"></div>
    </div>
</div>

<script>
    const API_URL = "https://special-spork-j9q69qr9wxjh7q6-8000.app.github.dev/api/demand";
    const GEOJSON_FILE = "/public/taxi_zones.json"; 

    let map, geoLayer, taxiData = {}, allFeatures = [];
    let selectedZoneId = null;

    const THRESHOLDS = { LOW: 0.0270, MEDIUM: 0.0421 };

    function getCongestionLevel(val) {
        if (!val) return { label: 'Low', class: 'status-low' };
        if (val <= THRESHOLDS.LOW) return { label: 'Low', class: 'status-low' };
        if (val <= THRESHOLDS.MEDIUM) return { label: 'Medium', class: 'status-medium' };
        return { label: 'High', class: 'status-high' };
    }

    // Helper to estimate speed from congestion (assuming 25mph base)
    function calculateSpeedFromIndex(index) {
        return Math.max(5, (25 - (index * 200))).toFixed(1); 
    }

    function toggleTheme() {
        const html = document.documentElement;
        const icon = document.getElementById('themeIcon');
        if (html.getAttribute('data-theme') === 'light') {
            html.setAttribute('data-theme', 'dark');
            icon.setAttribute('data-lucide', 'sun');
            updateMapStyle('dark');
        } else {
            html.setAttribute('data-theme', 'light');
            icon.setAttribute('data-lucide', 'moon');
            updateMapStyle('light');
        }
        lucide.createIcons();
    }

    function updateMapStyle(theme) {
        const url = theme === 'dark' 
            ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
            : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
        L.tileLayer(url).addTo(map);
    }

    function updateClock() {
        const now = new Date();
        const opts = { timeZone: 'America/New_York' };
        document.getElementById('liveClock').innerText = now.toLocaleTimeString('en-US', { ...opts, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
        document.getElementById('liveDate').innerText = now.toLocaleDateString('en-US', { ...opts, weekday: 'long', year: 'numeric', month: 'long', day: '2-digit' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    function getDemandColor(d) {
        return d > 200 ? '#312e81' : d > 120 ? '#4338ca' : d > 60 ? '#6366f1' : d > 20 ? '#a5b4fc' : d > 0 ? '#e0e7ff' : '#f1f5f9';
    }

    async function init() {
        lucide.createIcons();
        map = L.map('map', { zoomControl: false }).setView([40.7128, -74.0060], 11);
        updateMapStyle('light');

        try {
            const [demandRes, geoRes] = await Promise.all([
                fetch(API_URL).then(r => r.json()),
                fetch(GEOJSON_FILE).then(r => r.json())
            ]);

            taxiData = demandRes.predictions;
            allFeatures = geoRes.features;
            
            updateCitywideHeader();
            updateDashboard();

            document.getElementById('boroughFilter').addEventListener('change', () => {
                selectedZoneId = null; 
                updateDashboard();
                fitMapToFilter();
            });

            document.getElementById('zoneSearch').addEventListener('input', () => {
                selectedZoneId = null;
                updateDashboard();
            });
            
            renderMap(geoRes);

        } catch (err) { console.error("Data Load Error:", err); }
    }

    function updateCitywideHeader() {
        const zones = Object.values(taxiData);
        if (zones.length === 0) return;

        const first = zones[0];
        if (first) {
            const cityIdx = first.city_congestion_index || 0;
            const cityLevel = getCongestionLevel(cityIdx);

            document.getElementById('cityAvgSpeed').innerText = `${calculateSpeedFromIndex(cityIdx)} MPH`;
            document.getElementById('cityCongestion').innerText = cityIdx.toFixed(3);
            document.getElementById('cityCongestionLevel').innerText = cityLevel.label;
            document.getElementById('cityFeelsLike').innerText = `${first.feelslike}Â°F`;
            document.getElementById('cityHumidity').innerText = `${first.humidity}%`;
        }
    }

    function fitMapToFilter() {
        const bFilter = document.getElementById('boroughFilter').value;
        const bounds = L.latLngBounds();
        let count = 0;
        geoLayer.eachLayer(layer => {
            if (bFilter === 'All' || layer.feature.properties.borough === bFilter) {
                bounds.extend(layer.getBounds());
                count++;
            }
        });
        if (count > 0) map.flyToBounds(bounds, { padding: [30, 30], duration: 1.5 });
    }

    function updateDashboard() {
        const bFilter = document.getElementById('boroughFilter').value;
        const sQuery = document.getElementById('zoneSearch').value.toLowerCase();
        const list = document.getElementById('zoneList');
        const listTitle = document.getElementById('listTitle');
        const clearBtn = document.getElementById('clearSelection');

        let filtered;
        if (selectedZoneId) {
            filtered = allFeatures.filter(f => (f.properties.location_id || f.properties.OBJECTID) == selectedZoneId);
            listTitle.innerText = "Selected Zone Details";
            clearBtn.style.display = 'block';
        } else {
            filtered = allFeatures.filter(f => {
                const matchesBorough = bFilter === 'All' || f.properties.borough === bFilter;
                const matchesSearch = f.properties.zone.toLowerCase().includes(sQuery);
                return matchesBorough && matchesSearch;
            });
            listTitle.innerText = `Top ${Math.min(filtered.length, 20)} Results`;
            clearBtn.style.display = 'none';
        }

        const data = filtered.map(f => {
            const id = f.properties.location_id || f.properties.OBJECTID;
            const stats = taxiData[id] || { target_yellow: 0, target_green: 0, target_hvfhv: 0, zone_congestion_index: 0 };
            const total = stats.target_yellow + stats.target_green + stats.target_hvfhv;
            return { f, total, id, stats };
        });

        if (!selectedZoneId) data.sort((a, b) => b.total - a.total);
        const displayData = selectedZoneId ? data : data.slice(0, 20);

        list.innerHTML = displayData.map(item => {
            const cong = getCongestionLevel(item.stats.zone_congestion_index);
            return `
                <div class="detail-card ${selectedZoneId == item.id ? 'active' : ''}" id="card-${item.id}" onclick="focusZone('${item.id}')">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-weight:800; font-size:0.85rem; color:var(--text);">${item.f.properties.zone}</div>
                            <div style="font-size:0.6rem; color:var(--subtext); margin-bottom:4px;">${item.f.properties.borough}</div>
                            <div class="congestion-indicator ${cong.class}">Traffic: ${cong.label}</div>
                        </div>
                        <div style="font-weight:900; font-size:0.75rem; color:var(--text);">${(item.stats.zone_congestion_index || 0).toFixed(3)} <span style="font-weight:500; font-size:0.6rem;">IDX</span></div>
                    </div>
                    <div class="demand-row">
                        <div class="stat-box" style="background:#fef9c3; color:#854d0e;">YEL: ${Math.round(item.stats.target_yellow)}</div>
                        <div class="stat-box" style="background:#dcfce7; color:#166534;">GRN: ${Math.round(item.stats.target_green)}</div>
                        <div class="stat-box" style="background:#ede9fe; color:#5b21b6;">FHV: ${Math.round(item.stats.target_hvfhv)}</div>
                    </div>
                </div>`;
        }).join('');
    }

    function renderMap(geoData) {
        geoLayer = L.geoJson(geoData, {
            style: (f) => {
                const id = f.properties.location_id || f.properties.OBJECTID;
                const total = (taxiData[id]?.target_yellow || 0) + (taxiData[id]?.target_green || 0) + (taxiData[id]?.target_hvfhv || 0);
                return { fillColor: getDemandColor(total), fillOpacity: 0.7, weight: 1, color: 'white' };
            },
            onEachFeature: (f, layer) => {
                const id = f.properties.location_id || f.properties.OBJECTID;
                layer.on({
                    mouseover: (e) => {
                        const d = taxiData[id] || { target_yellow: 0, target_green: 0, target_hvfhv: 0, zone_congestion_index: 0 };
                        const total = d.target_yellow + d.target_green + d.target_hvfhv;
                        const cong = getCongestionLevel(d.zone_congestion_index);
                        layer.setStyle({ weight: 3, color: '#4338ca', fillOpacity: 0.8 });
                        layer.bindTooltip(`
                            <div class="hover-tooltip">
                                <span class="tooltip-title">${f.properties.zone}</span>
                                <div class="congestion-indicator ${cong.class}" style="margin-bottom:8px">${cong.label} Congestion</div><br>
                                <span class="tooltip-stat">Live Demand: <span class="tooltip-value">${Math.round(total)} trips</span></span><br>
                                <span class="tooltip-stat">Congestion Index: <span class="tooltip-value">${(d.zone_congestion_index || 0).toFixed(3)}</span></span>
                            </div>`, { sticky: true }).openTooltip();
                    },
                    mouseout: (e) => { geoLayer.resetStyle(e.target); },
                    click: (e) => { 
                        L.DomEvent.stopPropagation(e);
                        selectedZoneId = id;
                        updateDashboard();
                        map.fitBounds(layer.getBounds(), { padding: [100, 100], maxZoom: 14 });
                    }
                });
            }
        }).addTo(map);
    }

    function focusZone(id) {
        selectedZoneId = id;
        updateDashboard();
        geoLayer.eachLayer(l => {
            if((l.feature.properties.location_id || l.feature.properties.OBJECTID) == id) {
                map.fitBounds(l.getBounds(), { padding: [100, 100], maxZoom: 14 });
            }
        });
    }

    function resetSelection() {
        selectedZoneId = null;
        updateDashboard();
        fitMapToFilter();
    }

    init();
</script>
</body>
</html>