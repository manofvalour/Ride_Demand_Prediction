<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>NYC Demand & Congestion Intelligence - 2026</title>

    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #4338ca;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
        }

        body, html { height: 100%; margin: 0; font-family: 'Inter', -apple-system, sans-serif; overflow: hidden; background: var(--bg); }
        .app-layout { display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        .header-banner {
            background: var(--surface);
            padding: 0.75rem 1.5rem;
            display: flex;
            gap: 1.5rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
            z-index: 1001;
        }

        .clock-section { display: flex; flex-direction: column; min-width: 200px; }
        #liveClock { font-weight: 900; font-size: 1.1rem; color: var(--text); letter-spacing: -0.02em; line-height: 1; }
        #liveDate { font-size: 0.65rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-top: 4px; }

        .citywide-counter {
            margin-left: 20px;
            padding-left: 20px;
            border-left: 2px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .citywide-label { font-size: 0.65rem; color: #64748b; text-transform: uppercase; font-weight: 800; }
        .citywide-value { color: var(--primary); font-size: 1.2rem; font-weight: 900; line-height: 1; }

        /* MAIN UI */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 380px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 1000; }
        .search-container { padding: 1rem; border-bottom: 1px solid var(--border); }
        .search-input-wrapper { position: relative; }
        .search-input-wrapper input {
            width: 100%; padding: 12px 12px 12px 40px; border-radius: 10px; border: 1px solid var(--border);
            font-size: 0.9rem; outline: none; box-sizing: border-box;
        }
        .search-input-wrapper i { position: absolute; left: 12px; top: 13px; color: #94a3b8; }

        .scroll-area { flex: 1; overflow-y: auto; padding: 1rem; }
        #map { flex: 1; background: #cbd5e1; }

        /* CARDS & LABELS */
        .detail-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }
        .detail-card:hover { border-color: #cbd5e1; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .detail-card.active { border: 2px solid var(--primary); background: #f5f3ff; }
        
        .congestion-indicator {
            font-size: 0.6rem; font-weight: 900; padding: 2px 6px; border-radius: 4px;
            text-transform: uppercase; display: inline-block; margin-top: 4px;
        }
        .status-high { background: #fee2e2; color: #991b1b; }
        .status-moderate { background: #fef3c7; color: #92400e; }
        .status-low { background: #dcfce7; color: #166534; }

        .demand-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-top: 10px; }
        .stat-box { padding: 6px; border-radius: 6px; text-align: center; font-size: 0.65rem; font-weight: 800; }

        .hover-tooltip { padding: 5px; font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>

<div class="app-layout">
    <header class="header-banner">
        <div class="clock-section">
            <div id="liveClock">--:--:-- --</div>
            <div id="liveDate">---, --- --, ----</div>
        </div>

        <div style="display:flex; gap:15px; font-weight:700; font-size:0.9rem; border-left: 2px solid var(--border); padding-left: 20px;">
            <span><i data-lucide="thermometer" size="16"></i> <span id="temp">--°F</span></span>
            <span><i data-lucide="cloud-rain" size="16"></i> <span id="precip">-- in</span></span>
        </div>

        <div class="citywide-counter">
            <span class="citywide-label">Citywide Demand</span>
            <span id="totalCityDemand" class="citywide-value">0</span>
        </div>

        <div style="margin-left: auto; font-size: 0.6rem; font-weight: 900; background: #fee2e2; color: #b91c1c; padding: 4px 10px; border-radius: 6px; border: 1px solid #fecaca;">
            <i data-lucide="alert-triangle" size="12" style="display:inline; margin-right:4px;"></i>NYC LOCAL TIME ENABLED
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <div class="search-container">
                <div class="search-input-wrapper">
                    <i data-lucide="search" size="18"></i>
                    <input type="text" id="zoneSearch" placeholder="Search neighborhood...">
                </div>
            </div>
            <div style="padding: 1rem 1rem 0.5rem 1rem; background: #fafafa;">
                <div id="listTitle" style="font-weight: 800; color: var(--primary); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em;">Top 10 Active Zones</div>
            </div>
            <div class="scroll-area" id="zoneList"></div>
        </aside>
        <div id="map"></div>
    </div>
</div>

<script>
    const API_URL = "https://special-spork-j9q69qr9wxjh7q6-8000.app.github.dev/api/demand";
    const GEOJSON_FILE = "/public/taxi_zones.json"; 

    let map, geoLayer, taxiData = {}, allFeatures = [];

    // CLOCK LOGIC - FORCED NYC TIME
    function updateClock() {
        const now = new Date();
        const timeOptions = { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
        const dateOptions = { timeZone: 'America/New_York', weekday: 'long', year: 'numeric', month: 'long', day: '2-digit' };
        
        document.getElementById('liveClock').innerText = now.toLocaleTimeString('en-US', timeOptions);
        document.getElementById('liveDate').innerText = now.toLocaleDateString('en-US', dateOptions);
    }
    setInterval(updateClock, 1000);
    updateClock();

    function calculateSpeed(id, borough, total) {
        let base = (borough === 'Manhattan') ? (id <= 140 ? 7.1 : 9.5) : 13.8;
        const penalty = Math.min(3.5, total / 55);
        return parseFloat((base - penalty).toFixed(1));
    }

    function getCongestion(speed) {
        if (speed < 7) return { label: 'High Congestion', class: 'status-high' };
        if (speed < 12) return { label: 'Moderate', class: 'status-moderate' };
        return { label: 'Low Congestion', class: 'status-low' };
    }

    function getDemandColor(d) {
        return d > 200 ? '#312e81' : d > 120 ? '#4338ca' : d > 60 ? '#6366f1' : d > 20 ? '#a5b4fc' : d > 0 ? '#e0e7ff' : '#f1f5f9';
    }

    async function init() {
        lucide.createIcons();
        map = L.map('map', { zoomControl: false }).setView([40.7128, -74.0060], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        try {
            const [demandRes, geoRes] = await Promise.all([
                fetch(API_URL).then(r => r.json()),
                fetch(GEOJSON_FILE).then(r => r.json())
            ]);

            taxiData = demandRes.predictions;
            allFeatures = geoRes.features;
            
            updateCitywideHeader();
            renderSidebar(allFeatures);
            renderMap(geoRes);

            const sample = Object.values(taxiData)[0];
            if(sample) {
                document.getElementById('temp').innerText = `${sample.feelslike}°F`;
                document.getElementById('precip').innerText = `${sample.precip} in`;
            }

            document.getElementById('zoneSearch').addEventListener('input', (e) => {
                const q = e.target.value.toLowerCase();
                const listTitle = document.getElementById('listTitle');
                if (!q) {
                    listTitle.innerText = "Top 10 Active Zones";
                    renderSidebar(allFeatures);
                } else {
                    listTitle.innerText = "Search Results";
                    const filtered = allFeatures.filter(f => f.properties.zone.toLowerCase().includes(q)).slice(0, 15);
                    renderSidebar(filtered, true);
                }
            });

        } catch (err) { console.error("Data Load Error:", err); }
    }

    function updateCitywideHeader() {
        const total = Object.values(taxiData).reduce((s, z) => s + (z.target_yellow || 0) + (z.target_green || 0) + (z.target_hvfhv || 0), 0);
        document.getElementById('totalCityDemand').innerText = Math.round(total).toLocaleString();
    }

    function renderSidebar(features, isSearch = false) {
        const list = document.getElementById('zoneList');
        let data = features.map(f => {
            const id = f.properties.location_id || f.properties.OBJECTID;
            const stats = taxiData[id] || { target_yellow: 0, target_green: 0, target_hvfhv: 0 };
            const total = stats.target_yellow + stats.target_green + stats.target_hvfhv;
            return { f, total, id, stats };
        });

        if (!isSearch) data = data.sort((a, b) => b.total - a.total).slice(0, 10);

        list.innerHTML = data.map(item => {
            const speed = calculateSpeed(item.id, item.f.properties.borough, item.total);
            const cong = getCongestion(speed);
            return `
                <div class="detail-card" id="card-${item.id}" onclick="focusZone('${item.id}')">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-weight:800; font-size:0.85rem; color:var(--text);">${item.f.properties.zone}</div>
                            <div class="congestion-indicator ${cong.class}">${cong.label}</div>
                        </div>
                        <div style="font-weight:900; font-size:0.75rem; color:#475569;">${speed} <span style="font-weight:500; font-size:0.6rem;">MPH</span></div>
                    </div>
                    <div class="demand-row">
                        <div class="stat-box" style="background:#fef9c3; color:#854d0e;">YEL: ${Math.round(item.stats.target_yellow)}</div>
                        <div class="stat-box" style="background:#dcfce7; color:#166534;">GRN: ${Math.round(item.stats.target_green)}</div>
                        <div class="stat-box" style="background:#ede9fe; color:#5b21b6;">FHV: ${Math.round(item.stats.target_hvfhv)}</div>
                    </div>
                </div>`;
        }).join('');
    }

    function renderMap(geoData) {
        geoLayer = L.geoJson(geoData, {
            style: (f) => {
                const id = f.properties.location_id || f.properties.OBJECTID;
                const d = taxiData[id];
                const total = (d?.target_yellow || 0) + (d?.target_green || 0) + (d?.target_hvfhv || 0);
                return { fillColor: getDemandColor(total), fillOpacity: 0.7, weight: 1, color: 'white' };
            },
            onEachFeature: (f, layer) => {
                const id = f.properties.location_id || f.properties.OBJECTID;
                layer.on({
                    mouseover: (e) => {
                        const d = taxiData[id] || { target_yellow: 0, target_green: 0, target_hvfhv: 0 };
                        const total = d.target_yellow + d.target_green + d.target_hvfhv;
                        const speed = calculateSpeed(id, f.properties.borough, total);
                        const cong = getCongestion(speed);
                        
                        layer.setStyle({ weight: 3, color: '#4338ca', fillOpacity: 0.8 });
                        layer.bindTooltip(`
                            <div class="hover-tooltip">
                                <b style="font-size:13px">${f.properties.zone}</b><br>
                                <div class="congestion-indicator ${cong.class}" style="margin-top:5px">${cong.label}</div><br>
                                <span style="font-size:11px">Demand: <b>${Math.round(total)}</b> | <b>${speed} mph</b></span>
                            </div>`, { sticky: true }).openTooltip();
                    },
                    mouseout: (e) => { geoLayer.resetStyle(e.target); },
                    click: (e) => { L.DomEvent.stopPropagation(e); focusZone(id); }
                });
            }
        }).addTo(map);
    }

    function focusZone(id) {
        document.querySelectorAll('.detail-card').forEach(c => c.classList.remove('active'));
        const card = document.getElementById(`card-${id}`);
        if(card) { card.classList.add('active'); card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }

        geoLayer.eachLayer(l => {
            const lId = l.feature.properties.location_id || l.feature.properties.OBJECTID;
            if(lId == id) {
                map.fitBounds(l.getBounds(), { padding: [100, 100], maxZoom: 14 });
                const d = taxiData[id] || { target_yellow:0, target_green:0, target_hvfhv:0 };
                const total = Math.round(d.target_yellow + d.target_green + d.target_hvfhv);
                l.bindPopup(`<b>${l.feature.properties.zone}</b><br>Borough: ${l.feature.properties.borough}<br>Total Live Demand: ${total}`).openPopup();
            }
        });
    }

    init();
</script>
</body>
</html>